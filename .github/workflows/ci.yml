name: VisionQA CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  basic-checks:
    name: Temel Kontroller
    runs-on: ubuntu-latest
    
    steps:
      - name: Kodu Ã§ek
        uses: actions/checkout@v4
      
      - name: README kontrolÃ¼
        run: |
          test -f "README.md" && echo "âœ… README.md var" || (echo "âŒ README.md yok" && exit 1)
      
      - name: Proje yapÄ±sÄ± kontrolÃ¼
        run: |
          echo "ğŸ“ Proje klasÃ¶rleri kontrol ediliyor..."
          for dir in backend frontend executors docs .github; do
            test -d "$dir" && echo "âœ… $dir klasÃ¶rÃ¼ var" || (echo "âŒ $dir yok" && exit 1)
          done

  docker-checks:
    name: Docker Kontrolleri
    runs-on: ubuntu-latest
    needs: basic-checks
    
    steps:
      - uses: actions/checkout@v4
      
      - name: docker-compose.yml kontrolÃ¼
        run: |
          test -f "docker-compose.yml" && echo "âœ… docker-compose.yml var"
          docker compose config > /dev/null && echo "âœ… docker-compose.yml syntax doÄŸru"

  backend-tests:
    name: Backend Testleri
    runs-on: ubuntu-latest
    needs: docker-checks
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Python kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Backend dosya kontrolÃ¼
        run: |
          cd backend
          test -f main.py && echo "âœ… main.py var"
          test -f database.py && echo "âœ… database.py var"
          test -f requirements.txt && echo "âœ… requirements.txt var"
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium
      
      - name: Python syntax kontrolÃ¼
        run: |
          cd backend
          python -m py_compile main.py database/__init__.py database/models.py schemas.py
          echo "âœ… Python dosyalarÄ± syntax hatasÄ± yok"
      
      - name: Module import kontrolÃ¼
        run: |
          cd backend
          export PYTHONPATH=$PYTHONPATH:.
          python -c "import main; print('âœ… main.py import edildi')"
          python -c "import database; print('âœ… database import edildi')"
          python -c "from database import models; print('âœ… models import edildi')"
          python -c "import schemas; print('âœ… schemas import edildi')"
          python -c "from fastapi import FastAPI; print('âœ… FastAPI import edildi')"
      
      - name: Alembic konfigÃ¼rasyon kontrolÃ¼
        run: |
          cd backend
          export PYTHONPATH=$PYTHONPATH:.
          test -f alembic.ini && echo "âœ… alembic.ini var"
          test -f alembic/env.py && echo "âœ… alembic/env.py var"
          python -c "from alembic.config import Config; Config('alembic.ini'); print('âœ… Alembic config geÃ§erli')"

      - name: Router import kontrolÃ¼
        run: |
          cd backend
          export PYTHONPATH=$PYTHONPATH:.
          python -c "from routers.stats_router import router; print('âœ… stats_router import OK')"
          python -c "from routers import projects_router; print('âœ… projects_router import OK')"
          python -c "from database.models import Project, TestCase, TestRun, Finding; print('âœ… TÃ¼m modeller import OK')"

      - name: Run Backend Tests (Pytest)
        run: |
          cd backend
          export PYTHONPATH=$PYTHONPATH:.
          pip install pytest pytest-asyncio httpx
          if [ -d "tests" ] && [ "$(ls -A tests/)" ]; then
            pytest tests/ -v --tb=short
          else
            echo "âš ï¸ HenÃ¼z test dosyasÄ± yok, adÄ±m atlanÄ±yor."
          fi


  frontend-tests:
    name: Frontend Testleri
    runs-on: ubuntu-latest
    needs: docker-checks
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Node.js kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
        run: |
          cd frontend
          npm ci
          echo "âœ… Frontend baÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼klendi"
          
      - name: Lint kontrolÃ¼ (Kod Kalitesi)
        run: |
          cd frontend
          npm run lint
          echo "âœ… Frontend lint kontrolÃ¼ baÅŸarÄ±lÄ±"

      - name: Build kontrolÃ¼ (Derleme)
        run: |
          cd frontend
          npm run build
          echo "âœ… Frontend baÅŸarÄ±yla derlendi"

  success-notification:
    name: âœ… TÃ¼m Kontroller BaÅŸarÄ±lÄ±
    runs-on: ubuntu-latest
    needs: [basic-checks, docker-checks, backend-tests, frontend-tests]
    
    steps:
      - name: BaÅŸarÄ± mesajÄ±
        run: |
          echo "ğŸ‰ Tebrikler! TÃ¼m CI/CD kontrolleri baÅŸarÄ±lÄ±!"
          echo "âœ… Temel kontroller: PASSED"
          echo "âœ… Docker kontrolleri: PASSED"
          echo "âœ… Backend testleri: PASSED"
          echo "âœ… Frontend testleri: PASSED"
